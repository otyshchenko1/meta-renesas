From 323242d63a0993dcadb8aa7991131d6f4f5925cf Mon Sep 17 00:00:00 2001
From: Oleksandr Tyshchenko <oleksandr_tyshchenko@epam.com>
Date: Wed, 1 Aug 2018 17:59:44 +0300
Subject: [PATCH] Modify H3ULCB device tree to be able to run under Xen

Signed-off-by: Oleksandr Tyshchenko <oleksandr_tyshchenko@epam.com>
---
 arch/arm64/boot/dts/renesas/r8a7795-h3ulcb.dts | 90 +++++++++++---------------
 1 file changed, 38 insertions(+), 52 deletions(-)

diff --git a/arch/arm64/boot/dts/renesas/r8a7795-h3ulcb.dts b/arch/arm64/boot/dts/renesas/r8a7795-h3ulcb.dts
index 3b70272..3c785bb 100644
--- a/arch/arm64/boot/dts/renesas/r8a7795-h3ulcb.dts
+++ b/arch/arm64/boot/dts/renesas/r8a7795-h3ulcb.dts
@@ -17,61 +17,34 @@
 	model = "Renesas H3ULCB board based on r8a7795 ES2.0+";
 	compatible = "renesas,h3ulcb", "renesas,r8a7795";
 
-	memory@48000000 {
-		device_type = "memory";
-		/* first 128MB is reserved for secure area. */
-		reg = <0x0 0x48000000 0x0 0x38000000>;
-	};
-
-	memory@500000000 {
-		device_type = "memory";
-		reg = <0x5 0x00000000 0x0 0x40000000>;
-	};
-
-	memory@600000000 {
-		device_type = "memory";
-		reg = <0x6 0x00000000 0x0 0x40000000>;
-	};
-
-	memory@700000000 {
-		device_type = "memory";
-		reg = <0x7 0x00000000 0x0 0x40000000>;
-	};
-
-	reserved-memory {
-		#address-cells = <2>;
-		#size-cells = <2>;
-		ranges;
-
-		/* device specific region for Lossy Decompression */
-		lossy_decompress: linux,lossy_decompress {
-			no-map;
-			reg = <0x00000000 0x54000000 0x0 0x03000000>;
-		};
-
-		/* global autoconfigured region for contiguous allocations */
-		linux,cma {
-			compatible = "shared-dma-pool";
-			reusable;
-			reg = <0x00000000 0x57000000 0x0 0x19000000>;
-			linux,cma-default;
+	chosen {
+		xen,xen-bootargs = "dom0_mem=2G console=dtuart dtuart=serial0 dom0_max_vcpus=4 bootscrub=0 loglvl=all";
+		/* Uncomment this when using nfs as a boot device */
+		xen,dom0-bootargs = "console=hvc0 ignore_loglevel root=/dev/nfs nfsroot=192.168.1.100:/srv/h3ulcb,nfsvers=3 ip=192.168.1.10:192.168.1.100::255.255.255.0:h3ulcb cma=256M clk_ignore_unused";
+		/* Uncomment this when using block device as a boot device */
+		/* xen,dom0-bootargs = "console=hvc0 ignore_loglevel rw root=/dev/mmcblk1p1 rootfstype=ext4 rootwait cma=256M clk_ignore_unused"; */
+		/delete-property/stdout-path;
+		modules {
+			#address-cells = <2>;
+			#size-cells = <2>;
+			module@1 {
+				compatible = "xen,linux-zimage", "xen,multiboot-module";
+				reg = <0x0 0x7a000000 0x0 0x02000000>;
+			};
+			module@2 {
+				compatible = "xen,xsm-policy", "xen,multiboot-module";
+				reg = <0x0 0x7c000000 0x0 0x10000>;
+			};
 		};
-
-		/* device specific region for contiguous allocations */
-		mmp_reserved: linux,multimedia {
-			compatible = "shared-dma-pool";
-			reusable;
-			reg = <0x00000000 0x70000000 0x0 0x10000000>;
-		};
-	};
-
-	mmngr {
-		compatible = "renesas,mmngr";
-		memory-region = <&mmp_reserved>, <&lossy_decompress>;
 	};
 
-	mmngrbuf {
-		compatible = "renesas,mmngrbuf";
+	memory@48000000 {
+		device_type = "memory";
+		/* first 128MB is reserved for secure area. */
+		reg = <0x0 0x48000000 0x0 0x38000000>,
+		      <0x5 0x00000000 0x0 0x40000000>,
+		      <0x6 0x00000000 0x0 0x40000000>,
+		      <0x7 0x00000000 0x0 0x40000000>;
 	};
 
 	vspm_if {
@@ -84,6 +57,19 @@
 		/* Initial value of versaclock out3 */
 		clock-frequency = <33000000>;
 	};
+
+	soc {
+		/delete-node/pmu_a53;
+		/delete-node/thermal-zones;
+	};
+
+	cpus {
+		/delete-node/cpu@100;
+		/delete-node/cpu@101;
+		/delete-node/cpu@102;
+		/delete-node/cpu@103;
+		/delete-node/cpu-map;
+	};
 };
 
 &du {
-- 
2.7.4

